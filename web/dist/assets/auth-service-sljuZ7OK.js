import{f as k,c as a,g as C,t as i,h,i as E,k as S,m}from"./index-oSRV96JR.js";const f={auth:{code:"/_/code",verify:"/_/verify"}},p=k.create({baseURL:"/",timeout:3e4,headers:{"Content-Type":"application/json"}});p.interceptors.request.use(e=>{const t=a.getState().token,s=C("token"),o=t||s;return e.headers=e.headers??{},o&&(e.headers.Authorization=o.startsWith("Bearer ")?o:`Bearer ${o}`),e},e=>Promise.reject(e));p.interceptors.response.use(e=>{const t=e.data;if(t&&typeof t=="object"&&"error"in t&&"status"in t){const s=t;s.error&&s.status&&s.status>=400&&i.error(s.error||"An error occurred")}return e},async e=>{switch(e.response?.status){case 401:{if(!(e.config?.url?.includes("/login")||e.config?.url?.includes("/auth")||e.config?.url?.includes("/verify"))){h("token"),h("mochi_me"),a.getState().clearAuth(),i.error("Session expired",{description:"Please log in again to continue."});const o=window.location.href;window.location.href=`undefined?redirect=${encodeURIComponent(o)}`}break}case 403:{i.error("Access denied",{description:"You don't have permission to perform this action."});break}case 404:break;case 500:case 502:case 503:{i.error("Server error",{description:"Something went wrong on our end. Please try again later."});break}default:e.response||i.error("Network error",{description:"Please check your internet connection and try again."})}return Promise.reject(e)});class u extends Error{status;data;cause;constructor({message:t,status:s,data:o,cause:r}){super(t),this.name="ApiError",this.status=s,this.data=o,r!==void 0&&(this.cause=r)}}const v=(e,t,s)=>{if(E(e)){const o=e,r=o.response?.status,n=o.response?.data,d=n?.message??o.message??`${s.method??"request"} ${s.url} failed`;return new u({message:d,status:r,data:n,cause:e})}return e instanceof u?e:e instanceof Error?new u({message:e.message||t,cause:e}):new u({message:t,data:e})},A=(e,t)=>{};async function c(e){const t={...e};try{const s=await p.request(t),o=s.data;if(o&&typeof o=="object"&&"error"in o&&"status"in o){const r=o;if(r.error&&r.status&&r.status>=400){const n=new u({message:r.error,status:r.status,data:o});throw A(n,t),n}}return s.data}catch(s){throw v(s,"Unexpected API error",t)}}const w={get:(e,t)=>c({method:"GET",url:e,...t}),post:(e,t,s)=>c({method:"POST",url:e,data:t,...s}),put:(e,t,s)=>c({method:"PUT",url:e,data:t,...s}),patch:(e,t,s)=>c({method:"PATCH",url:e,data:t,...s}),delete:(e,t)=>c({method:"DELETE",url:e,...t})},q=e=>w.post(f.auth.code,e),P=e=>w.post(f.auth.verify,e),g={requestCode:q,verifyCode:P},x=async e=>{try{const t=await g.requestCode({email:e}),s=t.status?.toLowerCase(),o=t.data?.code;if(!(s==="ok"||!!o))throw new Error(t.message||"Failed to request login code");m({email:e});const n=a.getState().user;return a.getState().setUser({...n,email:e}),t}catch(t){throw console.error("Failed to request login code",t),t}},T=async e=>{try{const t=await g.verifyCode({code:e}),s=t.token||"",o=S(),r=o.email,n=t.user?.email||r,d=t.name||t.user?.name,l=t.success!==void 0?!!t.success:!!s;if(l&&s){n&&!o.email&&m({email:n});const y=n?{email:n,...d?{name:d}:o.name?{name:o.name}:{},accountNo:t.user?.accountNo,role:t.user?.role,exp:t.user?.exp}:null;a.getState().setAuth(y,s)}return{...t,success:l}}catch(t){throw console.error("Failed to verify login code",t),t}},$=async({name:e,privacy:t})=>{try{const s=new URLSearchParams;s.set("name",e),s.set("privacy",t);const o=await fetch(`${window.location.origin}/_/identity`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:s});if(!o.ok)throw new Error(`Identity request failed with status ${o.status}`);a.getState().setIdentity(e,t)}catch(s){throw console.error("Failed to submit identity",s),s}};export{x as r,$ as s,T as v};
